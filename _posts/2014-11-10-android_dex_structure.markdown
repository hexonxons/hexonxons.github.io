---
layout: post
title:  "Структура .dex файла."
date:   2014-11-10 02:00:00
categories: android dex
---
Основная информация по структуре .dex файла находится по адресу: [Android dex format][dex-format]

| Секция     | Формат           | Описание                                                                                                                                                                                                                                                                                                                                                                 |
|:-----------|:-----------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| header     | header_item      | Хедер файла.                                                                                                                                                                                                                                                                                                                                                             |
| string_ids | string_id_item[] | Массив id'шников строк.<br>Сюда входят id всех строк, используемых .dex файлом. These are identifiers for all the strings used by this file, either for internal naming (e.g., type descriptors) or as constant objects referred to by code.<br>Массив должен быть отсортирован по UTF-16 значениям строк (независимо от локали) и не содержать повторяющихся элементов. |
| type_ids   | type_id_item[]   | Массив id'шников типов.<br>Сюда входят id всех типов(классы, массивы или примитивные типы), на которые ссылается этот файл, вне зависимости - определены они в нем или нет.<br>Массив должен быть отсортирован по `string_id` и не содержать повторяющихся элементов.                                                                                                    |
| proto_ids  | proto_id_item[]  | Массив id'шников прототипов.<br>Сюда входят id всех прототипов, на которые ссылается этот файл.<br>Массив должен быть отсортирован по возвращаемому типу (`type_id`) и после по аргументами (`type_id`) и не содержать повторяющихся элементов.                                                                                                                          |
| field_ids  | field_id_item[]  | Массив id'шников полей.<br>Сюда входят id всех полей, на которые ссылается этот файл, вне зависимости - определены они в нем или нет.<br>Массив должен быть отсортирован по типу определения (`type_id`), имени поля (`string_id`) и после по типу (`type_id`) и не содержать повторяющихся элементов.                                                                   |
| method_ids | method_id_item[] | Массив id'шников методов.<br>Сюда входят id всех методов, на которые ссылается этот файл, вне зависимости - определены они в нем или нет.<br>Массив должен быть отсортирован по типу определения (`type_id`), имени метода (`string_id`) и после по прототипу метода (`proto_id`) и не содержать повторяющихся элементов.                                                |
| class_defs | class_def_item[] | Массив определений классов.<br>Массив должен быть отсортирован так, чтобы суперклассы и имплементированные интерфейсы появились в нем раньше, чем описываемый класс и не содержать повторяющихся элементов.                                                                                                                                                              |
| data       | ubyte[]          | Секция данных.<br>Содержит все вспомогательны данные для описанных выше секций.<br>Различные секции имеют различный сдвиг, поэтому между ними могут находиться некоторое количество байтов для обеспечения правильного сдвига.                                                                                                                                           |
| link_data  | ubyte[]          | Секция данных статически слинкованных файлов.<br>Конкретной спецификации нет. Секция может быть пуста при отсутствии статически слинкованных файлов.                                                                                                                                                                                                                     |

### Структура секций.

#### header_item:

| Название        | Формат      | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|:----------------|:------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| magic           | ubyte[8]    | Любой .dex файл начинается с магической последовательности `ubyte[8] DEX_FILE_MAGIC = { 0x64 0x65 0x78 0x0a 0x30 0x33 0x35 0x00 } = "dex\n035\0"`.<br>Эта информация нужна для распознавания .dex файла как такового. Символы `"\n"` или `0x0a` и `"\0"` или `0x00` нужны для обнаружения некоторых форм повреждений файла.Так же последовательность содержит 3 цифры - версию формата, соответственно эта последовательность может отличаться от представленной. |
| checksum        | uint        | Чексумма .dex файла формата [adler32][adler-32]. Чексумма считается от всего содержимого файла кроме magic и checksum. Используется для проверки целостности файла.                                                                                                                                                                                                                                                                                               |
| signature       | ubyte[20]   | [SHA-1][SHA-1] хеш от всего содержимого файла кроме magic, checksum и signature. Используется для уникальной идентификации файла.                                                                                                                                                                                                                                                                                                                                 |
| file_size       | uint        | Размер .dex файла в байтах, включая хедер.                                                                                                                                                                                                                                                                                                                                                                                                                        |
| header_size     | uint = 0x70 | Размер всего хедера в байтах. Это поле существует для возможности изменений хедера и сохранения обратной совместимости без изменения формата файла целиком.                                                                                                                                                                                                                                                                                                       |
| endian_tag      | uint        | Константа задающая порядок байтов файла. Стандартный порядок байтов .dex файла - little endian: `REVERSE_ENDIAN_CONSTANT = 0x78563412`, другое возможное значение big endian: `ENDIAN_CONSTANT = 0x12345678`, это зависит от реализации.                                                                                                                                                                                                                          |
| link_size       | uint        | Размер link-секции .dex файла или 0, если это не статически слинкованный файл.                                                                                                                                                                                                                                                                                                                                                                                    |
| link_off        | uint        | Сдвиг от начала файла до секции `link_data` или 0, если `link_size == 0`.                                                                                                                                                                                                                                                                                                                                                                                         |
| map_off         | uint        | Сдвиг от начала файла до секции `map_list` или 0, если секция отсутствует. The offset, if non-zero, should be to an offset into the data section, and the data should be in the format specified by "map_list" below.                                                                                                                                                                                                                                             |
| string_ids_size | uint        | Количество элементов в the string identifiers list.                                                                                                                                                                                                                                                                                                                                                                                                               |
| string_ids_off  | uint        | Сдвиг от начала файла до string identifiers list или 0, если `string_ids_size == 0` (возможный но странный случай).                                                                                                                                                                                                                                                                                                                                               |
| type_ids_size   | uint        | Количество элементов в type identifiers list.                                                                                                                                                                                                                                                                                                                                                                                                                     |
| type_ids_off    | uint        | Сдвиг от начала файла до type identifiers list или 0, если `type_ids_size == 0` (возможный но странный случай).                                                                                                                                                                                                                                                                                                                                                   |
| proto_ids_size  | uint        | Количество элементов в prototype identifiers list.                                                                                                                                                                                                                                                                                                                                                                                                                |
| proto_ids_off   | uint        | Сдвиг от начала файла до prototype identifiers list или 0, если `proto_ids_size == 0` (возможный но странный случай).                                                                                                                                                                                                                                                                                                                                             |
| field_ids_size  | uint        | Количество элементов в field identifiers list.                                                                                                                                                                                                                                                                                                                                                                                                                    |
| field_ids_off   | uint        | Сдвиг от начала файла до field identifiers list или 0, если `field_ids_off == 0`.                                                                                                                                                                                                                                                                                                                                                                                 |
| method_ids_size | uint        | Количество элементов в method identifiers list.                                                                                                                                                                                                                                                                                                                                                                                                                   |
| method_ids_off  | uint        | Сдвиг от начала файла до method identifiers list или 0, если `method_ids_size == 0`.                                                                                                                                                                                                                                                                                                                                                                              |
| class_defs_size | uint        | Количество элементов в class definitions list.                                                                                                                                                                                                                                                                                                                                                                                                                    |
| class_defs_off  | uint        | Сдвиг от начала файла до class definitions list или 0, если `class_defs_size == 0` (возможный но странный случай).                                                                                                                                                                                                                                                                                                                                                |
| data_size       | uint        | Размер секции данных в байтах.                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| class_defs_off  | uint        | Сдвиг от начала файла до секции данных.                                                                                                                                                                                                                                                                                                                                                                                                                           |  
  
Рассмотрим на примере [скомпилированного файла][dex-attach].  
Откроем его в любом hex-редакторе:

    64 65 78 0A 30 33 35 00 27 1E 4C 5C F0 85 81 7F 52 C3 5D 55 B4 99 13 04 0F E5 8A D6 37 09 B4 2F 70 07 00 00 70 00 00 00 78 56 34 12 00 00 00 00 00 00 00 00 A0 06 00 00 22 00 00 00 70 00 00 00 0F 00 00 00 F8 00 00 00 03 00 00 00 34 01 00 00 03 00 00 00 58 01 00 00 0B 00 00 00 70 01 00 00 06 00 00 00 C8 01 00 00 E8 04 00 00 88 02 00 00


[dex-format]:   https://source.android.com/devices/tech/dalvik/dex-format.html
[adler-32]:     https://ru.wikipedia.org/wiki/Adler-32
[SHA-1]:        http://ru.wikipedia.org/wiki/SHA-1
[dex-attach]:   /data/binary/classes.dex
